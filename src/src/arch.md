# 無網格變形系統 - 程式架構文檔

## 📋 概述

本專案實現了基於 Shape Matching 算法的無網格變形系統，使用 Three.js 與 TypeScript 建構。系統允許使用者載入 3D 模型並進行即時的物理變形模擬。

## 🏗️ 整體系統架構

┌─────────────────────────────────────────────────────────────┐
│                     用戶介面層 (UI Layer)                      │
├─────────────────────────────────────────────────────────────┤
│  index.html │ lil-gui (GUI控制) │ stats.js (性能監控)          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    應用程式層 (Application Layer)               │
├─────────────────────────────────────────────────────────────┤
│         scene.ts / scene-enhanced.ts (主場景邏輯)              │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐    │
│  │   事件處理   │   物件管理   │   動畫循環   │   GUI設定   │    │
│  └─────────────┴─────────────┴─────────────┴─────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    核心算法層 (Algorithm Layer)                │
├─────────────────────────────────────────────────────────────┤
│                shapeMatching.ts (核心算法)                    │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐    │
│  │ Shape Match │ 物理積分    │ 頂點處理    │ 矩陣計算    │    │
│  └─────────────┴─────────────┴─────────────┴─────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    工具函數層 (Utility Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  objloader    │ animations  │ fullscreen │ responsiveness │   │
│  plane        │            (輔助功能模組)                     │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    渲染引擎層 (Rendering Layer)                │
├─────────────────────────────────────────────────────────────┤
│                    Three.js WebGL 渲染器                      │
└─────────────────────────────────────────────────────────────┘

## 📁 檔案結構與職責

### 主要應用程式檔案

#### scene.ts (基礎版本)
- *職責*: 基本的 3D 場景管理和 Shape Matching 實現
- *主要功能*:
  - 場景初始化 (相機、燈光、渲染器)
  - 基本物件載入和管理
  - 用戶輸入處理 (鍵盤、滑鼠)
  - 基本 Shape Matching 算法調用
  - GUI 控制介面設定

#### scene-enhanced.ts (增強版本)
- *職責*: 增強的物理模擬和更進階的功能
- *主要功能*:
  - 增強的物理狀態管理 (PhysicsState)
  - 更複雜的頂點固定系統
  - 自動恢復功能
  - 改良的互動控制
  - 更詳細的統計信息

### 核心算法模組

#### helpers/shapeMatching.ts
- *職責*: 實現 Shape Matching 算法的核心邏輯
- *主要介面*:
  
  interface ShapeMatchingParams {
    deformationType: 'rotation' | 'linear' | 'quadratic'
    beta: number      // 線性/旋轉混合比例
    tau: number       // 彈性係數
    perturbation: number // 正則化參數
    dampingFactor: number // 阻尼係數
    fixedVertices?: Set<number> // 固定頂點集合
  }

  interface PhysicsState {
    positions: Vector3[]     // 當前位置
    velocities: Vector3[]    // 速度
    forces: Vector3[]        // 力
    masses: number[]         // 質量
    restPositions: Vector3[] // 靜止位置
    Q: Matrix3[]            // 變形矩陣
    AqqInv: Matrix3         // 逆矩陣
  }
  

- *核心函數*:
  - enhancedShapeMatching(): 基本 Shape Matching
  - enhancedShapeMatchingWithPhysics(): 物理增強版本
  - integratePhysics(): 物理積分步驟
  - getVerticesFromObject(): 從 Three.js 物件提取頂點

### 工具函數模組

#### helpers/objloader.ts / helpers/objloader-enhanced.ts
- *職責*: OBJ 模型檔案載入功能
- *功能*: 檔案讀取、解析、材質設定

#### helpers/responsiveness.ts
- *職責*: 響應式渲染管理
- *功能*: 視窗大小調整、設備像素比處理

#### helpers/fullscreen.ts
- *職責*: 全螢幕功能
- *功能*: 全螢幕切換邏輯

#### helpers/plane.ts
- *職責*: 地面網格生成
- *功能*: 創建格線紋理和地面平面

#### helpers/animations.ts
- *職責*: 動畫相關工具
- *功能*: 動畫控制和時間管理

## 🔄 數據流程圖

用戶輸入 (鍵盤/滑鼠/GUI)
           │
           ▼
    事件處理器 (scene.ts)
           │
           ▼
    物理狀態更新 (PhysicsState)
           │
           ▼
    Shape Matching 算法 (shapeMatching.ts)
           │
    ┌─────────┬─────────┬─────────┐
    ▼         ▼         ▼         ▼
  旋轉模式   線性模式   二次模式   混合模式
    │         │         │         │
    └─────────┴─────────┴─────────┘
           │
           ▼
    物理積分 (integratePhysics)
           │
           ▼
    頂點位置更新
           │
           ▼
    Three.js 幾何體更新
           │
           ▼
    WebGL 渲染

## 🎮 互動流程

### 1. 物件載入流程
選擇檔案 → OBJLoader 解析 → 幾何體創建 → 物理狀態初始化 → 場景添加

### 2. 變形操作流程
用戶輸入 → 力計算 → Shape Matching → 物理積分 → 頂點更新 → 渲染

### 3. 頂點固定流程
Shift + 點擊 → 射線檢測 → 頂點識別 → 固定狀態切換 → 視覺標記更新

## 🎛️ 主要控制系統

### 鍵盤控制
- I/K: 上下力
- J/L: 左右力  
- Space/B: 前後力
- R: 重置物件
- Shift + 點擊: 固定/解除固定頂點

### GUI 控制
- *模型文件夾*: OBJ 載入、預設物件
- *物理文件夾*: 物理參數調整
- *變形類型文件夾*: 算法模式選擇
- *視覺化文件夾*: 顯示選項
- *統計文件夾*: 性能監控

## 🧮 Shape Matching 算法架構

### 核心算法步驟
1. *質心計算*: 計算當前和靜止狀態的質心
2. *相對位置*: 計算相對於質心的位置向量
3. *變形矩陣*: 根據變形類型計算目標變形
4. *目標位置*: 計算每個頂點的目標位置
5. *物理積分*: 更新速度和位置

### 變形模式
- *旋轉模式* (rotation): 純旋轉變形，保持形狀
- *線性模式* (linear): 線性變形，允許拉伸
- *二次模式* (quadratic): 二次變形，更複雜的變形

## 🔧 技術棧

### 核心依賴
- *Three.js* ^0.174.0: 3D 圖形渲染引擎
- *TypeScript* ^5.8.2: 類型安全的 JavaScript
- *Vite* ^6.2.6: 現代化構建工具

### UI 與工具
- *lil-gui* ^0.20.0: 輕量級 GUI 控制介面
- *stats.js* ^0.17.0: 性能監控工具

### 構建與開發
- *@types/three*: Three.js 類型定義
- *WebGL*: 硬體加速 3D 渲染

## 📊 性能監控

### 統計指標
- *FPS*: 每秒幀數
- *頂點數*: 當前物件的頂點總數
- *三角形數*: 當前物件的三角形總數
- *記憶體使用*: 系統記憶體使用情況

### 最佳化策略
- 適應性縮放減少計算複雜度
- 固定頂點減少計算量
- 響應式渲染適應不同設備
- 物件狀態驗證防止無效計算

## 🔮 設計模式

### 1. 狀態管理模式
- PhysicsState 集中管理物理狀態
- SimulationParams 管理模擬參數

### 2. 策略模式
- 不同變形類型的算法切換
- 多種控制輸入方式

### 3. 觀察者模式
- GUI 參數變更自動更新場景
- 事件驅動的互動系統

### 4. 工廠模式
- 物件載入和初始化
- 材質和幾何體創建

## 🚀 擴展性

### 未來可能的擴展
1. *多物件支持*: 同時處理多個變形物件
2. *碰撞檢測*: 物件間的碰撞響應
3. *材質系統*: 更豐富的視覺效果
4. *動畫錄製*: 變形過程的錄製和播放
5. *WebXR 支持*: VR/AR 互動體驗

### 架構優勢
- 模組化設計便於維護和擴展
- 清晰的職責分離
- 類型安全的 TypeScript 實現
- 現代化的工具鏈支持

---

此文檔描述了無網格變形系統的完整架構，包含所有主要組件、數據流程和互動邏輯。
